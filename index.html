<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Royal Walk äº’å‹•åœ°åœ– Â· Admin ç‰ˆ</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

  <style>
    html, body, #map { height: 100%; margin: 0; }
    .topbar{
      position:fixed; left:12px; top:12px; z-index:9999;
      background:rgba(11,18,32,.85); color:#e6eefc;
      padding:10px 12px; border-radius:12px; border:1px solid #223355;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans", Arial;
      display:flex; flex-wrap:wrap; gap:8px; align-items:center;
    }
    .topbar button{ margin-right:0 }
    .pill{ display:inline-flex; align-items:center; gap:6px; font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid #2b406a; background:#0e1628; color:#cfe8ff }
    .pill input[type="color"]{ width:24px; height:18px; padding:0; border:none; background:transparent; cursor:pointer }
    .errorbox{
      position:fixed; right:12px; bottom:12px; z-index:9999;
      max-width:48ch; background:#2b1e1e; color:#ffdede; padding:10px 12px; border:1px solid #5d2b2b; border-radius:10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; white-space:pre-wrap;
    }
    /* å½©è‰²åœ“é»æ¨™è¨˜æ¨£å¼ */
    .u-dot { background: transparent; border: none; }
    .u-dot .dot { width: 16px; height: 16px; border-radius: 50%; border: 2px solid #fff; box-shadow: 0 0 0 2px rgba(0,0,0,.35); }
    /* åç¨±æ¨™ç±¤æ¨£å¼ */
    .leaflet-tooltip.mlabel { background: rgba(0,0,0,0.55); color:#fff; border:0; border-radius:6px; padding:2px 6px; font-size:12px; pointer-events:none; white-space:nowrap; }
  </style>
</head>
<body>

  <div class="topbar">
    <span class="pill" id="uid">æœªç™»å…¥</span>
    <span class="pill" id="roleTag">è§’è‰²ï¼šè¨ªå®¢</span>
    <span class="pill">æˆ¿é–“ï¼š<span id="roomName">default</span></span>
    <label class="pill">æˆ‘çš„é¡è‰² <input id="myColor" type="color" value="#ffcc00" title="æˆ‘çš„æ¨™è¨˜é¡è‰²"></label>
    <button id="btnAdd">ï¼‹ åœ¨é»æ“Šè™•æ–°å¢æ¨™è¨˜</button>
    <button id="btnEdit" disabled>âœ ç·¨è¼¯é¸å–æ¨™è¨˜</button>
    <button id="btnDel" disabled>ğŸ—‘ åˆªé™¤é¸å–æ¨™è¨˜</button>
    <span class="pill" id="ownerTag">æ“æœ‰è€…ï¼šâ€”</span>
    <span class="pill">æç¤ºï¼šé»åœ°åœ–â†’æŒ‰ã€Œï¼‹ã€æ–°å¢ï¼›æ‹–æ›³å¯ç§»å‹•</span>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- 1) Leafletï¼šä¸€å®šæŠŠåº•åœ–ç•«å‡ºä¾†ï¼ˆroyal-walk.png 1162Ã—843ï¼‰ -->
  <script>
    function showError(msg){
      let box = document.getElementById('err');
      if(!box){ box = document.createElement('div'); box.id='err'; box.className='errorbox'; document.body.appendChild(box); }
      box.textContent = msg;
    }
    window.addEventListener('error', e => showError('JS Error: ' + e.message));
    window.addEventListener('unhandledrejection', e => showError('Promise Error: ' + (e.reason && e.reason.message ? e.reason.message : e.reason)));

    const W = 1162, H = 843, IMG = 'royal-walk.png';
    const map = L.map('map', { crs: L.CRS.Simple, minZoom: -3, wheelPxPerZoomLevel: 80, zoomSnap: 0.25 });
    const sw = L.point(0, H), ne = L.point(W, 0);
    const bounds = L.latLngBounds(map.unproject(sw, 0), map.unproject(ne, 0));
    L.imageOverlay(IMG, bounds).addTo(map);
    map.fitBounds(bounds);

    const toLatLng = (x, y) => map.unproject(L.point(x, y), 0);
    const toXY     = (latlng) => map.project(latlng, 0);

    const markers = new Map(); // id -> Leaflet markerï¼ˆåŠ ä¸Šè‡ªè¨‚ m.__uid ï¼‰
    let selectedId = null;     // ç›®å‰é¸å–æ¨™è¨˜ id
    let pendingLatLng = null;  // é»åœ°åœ–ä¹‹å¾Œå¾…æ–°å¢çš„ä½ç½®

    map.on('click', (e) => {
      pendingLatLng = e.latlng;
      L.popup().setLatLng(e.latlng).setContent('å·²é¸åº§æ¨™ï¼šæŒ‰ã€Œï¼‹ã€æ–°å¢æ¨™è¨˜').openOn(map);
    });

    function setOwnerUI(text){ const el = document.getElementById('ownerTag'); if(el) el.textContent = 'æ“æœ‰è€…ï¼š' + text; }

    window.__leafletCtx = {
      map, toLatLng, toXY, markers, bounds,
      getSelectedId: ()=>selectedId,
      setSelectedId: (id)=>{ selectedId=id; updateButtons(); },
      getPendingLatLng: ()=>pendingLatLng,
      clearPending: ()=>{ pendingLatLng=null; },
      setUidText: (t)=>{ const el=document.getElementById('uid'); if(el) el.textContent=t; },
      setRoleText: (t)=>{ const el=document.getElementById('roleTag'); if(el) el.textContent='è§’è‰²ï¼š'+t; },
      setOwnerUI,
    };

    function updateButtons(){
      const edit = document.getElementById('btnEdit');
      const del  = document.getElementById('btnDel');
      const id = selectedId;
      if(!id){ edit.disabled = true; del.disabled = true; setOwnerUI('â€”'); return; }
      const m = markers.get(id);
      const owner = m && m.__uid ? m.__uid.slice(0,8) : 'â€”';
      setOwnerUI(owner);
    }
  </script>

  <!-- 2) Firebaseï¼šå¤šäººå³æ™‚åŒæ­¥ + Admin æ¬Šé™ + æ¯äººé¡è‰²ï¼ˆdocChanges é€ç­†åŒæ­¥ + å¸¸é§åç¨±ï¼‰ -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { getFirestore, collection, doc, addDoc, setDoc, deleteDoc, onSnapshot, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    // === ä½ çš„ Firebase å°ˆæ¡ˆè¨­å®šï¼ˆå»¶ç”¨å‰ä¸€ç‰ˆï¼‰ ===
    const firebaseConfig = {
      apiKey: "AIzaSyBFo_yIVjcl0ylyjU9Xu5TKCsEMUmKO9aM",
      authDomain: "royalwalk-3af37.firebaseapp.com",
      projectId: "royalwalk-3af37",
      storageBucket: "royalwalk-3af37.appspot.com", // å»ºè­°ä½¿ç”¨é è¨­ appspot.com æ ¼å¼
      messagingSenderId: "1054965727476",
      appId: "1:1054965727476:web:7132823b9008bdd0191ea1",
      measurementId: "G-QZ31DVYMBK"
    };

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // === Admin è¨­å®šï¼šå…©ä½ç®¡ç†å“¡ï¼ˆä½ çµ¦çš„ UIDï¼‰ ===
    const ADMIN_UIDS = new Set(['FqmcrTBEu6et37bj9egDcsd9aRv2']);
    const isAdminUser = (u)=> !!(u && ADMIN_UIDS.has(u.uid));

    // === ä½¿ç”¨è€…é¡è‰²ï¼ˆUID -> è‰²ç¥¨ï¼Œå¯è‡ªè¡Œæ”¹è‰²ï¼‰ ===
    const PALETTE = ['#ef4444','#f97316','#f59e0b','#84cc16','#22c55e','#10b981','#06b6d4','#0ea5e9','#3b82f6','#6366f1','#a855f7','#ec4899','#14b8a6','#8b5cf6','#eab308','#fb7185'];
    const hash = (s)=>{ let h=0; for(let i=0;i<s.length;i++){ h=(h*31 + s.charCodeAt(i))|0; } return Math.abs(h); };
    let userColor = '#ffcc00';

    const colorInput = document.getElementById('myColor');
    const room = new URLSearchParams(location.search).get('room') || 'default';
    document.getElementById('roomName').textContent = room;
    const colRef = collection(db, 'rooms', room, 'markers');

    const { map, toLatLng, toXY, markers, bounds,
            getSelectedId, setSelectedId, getPendingLatLng, clearPending, setOwnerUI } = window.__leafletCtx;

    const iconFor = (color)=> L.divIcon({ className: 'u-dot', html: `<div class="dot" style="background:${color}"></div>`, iconSize: [18,18], iconAnchor: [9,9] });

    // é¡¯ç¤ºåç¨±çš„å·¥å…·å‡½å¼ï¼šåœ¨åœ°åœ–ä¸Šæ°¸ä¹…é¡¯ç¤ºæ¨™è¨˜åç¨±
    const setMarkerLabel = (m, title) => {
      const txt = (title && String(title).trim()) ? String(title).trim() : 'æœªå‘½å';
      const tip = m.getTooltip ? m.getTooltip() : null;
      if (tip) tip.setContent(txt);
      else m.bindTooltip(txt, {permanent:true, direction:'top', offset:[0,-14], className:'mlabel'});
      m.options.title = title || '';
    };

    // åŒ¿åç™»å…¥ + è§’è‰²/é¡è‰²åˆå§‹åŒ–
    signInAnonymously(auth).catch((e)=> showError('åŒ¿åç™»å…¥å¤±æ•—ï¼š' + e.message));
    onAuthStateChanged(auth, (user)=>{
      const uidShort = user ? ('UID: ' + user.uid.slice(0,8)) : 'æœªç™»å…¥';
      window.__leafletCtx.setUidText(uidShort);
      window.__leafletCtx.setRoleText(isAdminUser(user) ? 'ç®¡ç†å“¡' : (user ? 'ä¸€èˆ¬' : 'è¨ªå®¢'));
      if (user) {
        const saved = localStorage.getItem('myColor');
        userColor = saved || PALETTE[ hash(user.uid) % PALETTE.length ];
        colorInput.value = userColor;
      }
      // é‡æ–°è©•ä¼°ç›®å‰é¸å–æ¨™è¨˜æ˜¯å¦å¯ç®¡ç†ï¼ˆä½œè€…æˆ– adminï¼‰
      const id = getSelectedId();
      const edit = document.getElementById('btnEdit');
      const del  = document.getElementById('btnDel');
      if(!id){ edit.disabled=true; del.disabled=true; setOwnerUI('â€”'); return; }
      const m = markers.get(id);
      const canManage = !!(user && m && (m.__uid === user.uid || isAdminUser(user)));
      edit.disabled = !canManage;
      del.disabled  = !canManage;
      setOwnerUI(m && m.__uid ? (m.__uid === user?.uid ? 'æœ¬äºº' : (isAdminUser(user) ? 'ç®¡ç†å“¡' : m.__uid.slice(0,8))) : 'â€”');
    });

    // ä½¿ç”¨è€…æ”¹è‰²ï¼šä¹‹å¾Œæ–°å¢çš„é»å°±ç”¨æ–°è‰²
    colorInput.addEventListener('input', ()=>{
      userColor = colorInput.value;
      localStorage.setItem('myColor', userColor);
    });

    // âœ… é€ç­†åŒæ­¥ï¼šæ–°å¢/ä¿®æ”¹/åˆªé™¤ï¼›ä¸åšå…¨é‡æ¸…ç†
    onSnapshot(
      colRef,
      (snap) => {
        snap.docChanges().forEach((ch) => {
          const id = ch.doc.id;

          if (ch.type === 'removed') {
            const m = markers.get(id);
            if (m) { m.remove(); markers.delete(id); }
            if (getSelectedId() === id) setSelectedId(null);
            return;
          }

          const d   = ch.doc.data();             // {x,y,title,color,uid,updatedAt}
          const ll  = toLatLng(d.x, d.y);
          const col = d.color || '#ffcc00';

          if (ch.type === 'added' && !markers.has(id)) {
            const m = L.marker(ll, { draggable: true, title: d.title || '', icon: iconFor(col) }).addTo(map);
            m.__uid = d.uid || '?';
            setMarkerLabel(m, d.title);

            m.on('click', () => {
              setSelectedId(id);
              m.openPopup();
              const user = auth.currentUser;
              const canManage = !!(user && (m.__uid === user.uid || isAdminUser(user)));
              document.getElementById('btnEdit').disabled = !canManage;
              document.getElementById('btnDel').disabled  = !canManage;
              setOwnerUI(canManage && m.__uid !== user?.uid ? 'ç®¡ç†å“¡' : (m.__uid === user?.uid ? 'æœ¬äºº' : (m.__uid ? m.__uid.slice(0,8) : 'â€”')));
            });

            m.on('dragend', async () => {
              const xy = toXY(m.getLatLng());
              try {
                // åªæ›´æ–°åº§æ¨™èˆ‡æ™‚é–“ï¼Œä¸æ”¹ color/title/uid
                await setDoc(doc(colRef, id), { x: xy.x, y: xy.y, updatedAt: serverTimestamp() }, { merge: true });
              } catch (err) { showError('æ›´æ–°å¤±æ•—ï¼š' + err.message); }
            });

            m.bindPopup(() => `<b>${d.title||'æœªå‘½å'}</b><br>x=${Math.round(d.x)}, y=${Math.round(d.y)}<br><small>ID:${id}</small>`);
            markers.set(id, m);
            return;
          }

          // modifiedï¼ˆæˆ– added ä½†æœ¬åœ°å·²æœ‰ï¼‰â†’ æ›´æ–°å…§å®¹
          const m = markers.get(id);
          if (!m) return; // é˜²å‘†
          m.setLatLng(ll);
          m.setIcon(iconFor(col));
          setMarkerLabel(m, d.title);
          m.__uid = d.uid || m.__uid || '?';
          m.setPopupContent(`<b>${d.title||'æœªå‘½å'}</b><br>x=${Math.round(d.x)}, y=${Math.round(d.y)}<br><small>ID:${id}</small>`);
        });
      },
      (err) => showError('è®€å–å¤±æ•—ï¼š' + err.message + '\nï¼ˆé€šå¸¸æ˜¯ Firestore æœªå»ºç«‹æˆ– Rules é˜»æ“‹ readï¼‰')
    );

    // å·¥å…·åˆ—æŒ‰éˆ•
    const $ = (id)=>document.getElementById(id);
    $('btnAdd').onclick = async (e)=>{
      e.preventDefault();
      if(!auth.currentUser){ alert('å°šæœªç™»å…¥ï¼Œè«‹ç¨å€™å†è©¦'); return; }
      const latlng = getPendingLatLng();
      if (!latlng) { alert('å…ˆåœ¨åœ°åœ–ä¸Šé»ä¸€ä¸‹ï¼Œé¸æ“‡åº§æ¨™ï¼Œå†æŒ‰ï¼‹'); return; }
      const xy = toXY(latlng);
      const title = prompt('æ¨™è¨˜æ¨™é¡Œï¼Ÿ','æ–°æ¨™è¨˜') || 'æ–°æ¨™è¨˜';
      try{
        await addDoc(colRef, {
          x: xy.x, y: xy.y, title,
          color: userColor,
          uid: auth.currentUser.uid,
          updatedAt: serverTimestamp(),
        });
        clearPending();
      }catch(err){ showError('å¯«å…¥å¤±æ•—ï¼š' + err.message); }
    };

    $('btnEdit').onclick = async (e)=>{
      e.preventDefault();
      if(!auth.currentUser){ alert('å°šæœªç™»å…¥'); return; }
      const id = getSelectedId();
      if (!id) { alert('å…ˆé»ä¸€ä¸‹è¦ç·¨è¼¯çš„æ¨™è¨˜'); return; }
      const m = markers.get(id); if (!m) return;
      if(!(isAdminUser(auth.currentUser) || m.__uid === auth.currentUser.uid)){
        alert('åªæœ‰ä½œè€…æˆ–ç®¡ç†å“¡å¯ç·¨è¼¯'); return;
      }
      const cur = m.options.title || '';
      const title = prompt('æ–°çš„æ¨™é¡Œï¼š', cur);
      if (title == null) return;
      const xy = toXY(m.getLatLng());
      try{
        await setDoc(doc(colRef, id), { title, x: xy.x, y: xy.y, updatedAt: serverTimestamp() }, { merge: true });
      }catch(err){ showError('æ›´æ–°å¤±æ•—ï¼š' + err.message); }
    };

    $('btnDel').onclick = async (e)=>{
      e.preventDefault();
      if(!auth.currentUser){ alert('å°šæœªç™»å…¥'); return; }
      const id = getSelectedId();
      if (!id) { alert('å…ˆé»ä¸€ä¸‹è¦åˆªé™¤çš„æ¨™è¨˜'); return; }
      const m = markers.get(id); if (!m) return;
      if(!(isAdminUser(auth.currentUser) || m.__uid === auth.currentUser.uid)){
        alert('åªæœ‰ä½œè€…æˆ–ç®¡ç†å“¡å¯åˆªé™¤'); return;
      }
      if (!confirm('ç¢ºå®šåˆªé™¤æ­¤æ¨™è¨˜ï¼Ÿ')) return;
      try{
        await deleteDoc(doc(colRef, id));
        setSelectedId(null);
      }catch(err){ showError('åˆªé™¤å¤±æ•—ï¼š' + err.message); }
    };

    map.fitBounds(bounds);
  </script>

  <!-- æé†’ï¼šè«‹æŠŠ royal-walk.png æ”¾åœ¨èˆ‡æœ¬æª”åŒå±¤ã€‚è‹¥è¦åˆ†æˆ¿ï¼šåŠ  ?room=walk1ã€‚Rules è¨­å®šè«‹ä½¿ç”¨ã€Œä½œè€…æˆ– admin å¯æ”¹/åˆªã€ç‰ˆæœ¬ã€‚ -->
</body>
</html>
